steps:
  - label: "compute node build {{matrix.profile}}"
    command: "ci/scripts/compute-node-build.sh -t {{matrix.target}} -p {{matrix.profile}}"
    key: "build"
    timeout_in_minutes: 15
    plugins:
      - docker-compose#v3.9.0:
          run: rw-build-env
          config: ci/docker-compose.yml
    matrix:
      setup:
        target:
          - "debug"
          - "release"
        profile:
          - "dev"
          - "release"
      adjustments:
        - with:
            target: "debug"
            profile: "release"
          skip: true
        - with:
            target: "release"
            profile: "dev"
          skip: true

#  - label: "compute node build dev"
#    command: "ci/scripts/compute-node-build.sh -t debug -p dev"
#    key: "dev"
#    plugins:
#      - docker-compose#v3.9.0:
#          run: rw-build-env
#          config: ci/docker-compose.yml
#      - artifacts#v1.5.0:
#          upload:
#            - from: target/debug/risingwave
#              to: risingwave-dev
#            - from: target/debug/risingwave_regress_test
#              to: risingwave_regress_test-dev
#            - from: target/debug/risedev-playground
#              to: risedev-playground-dev
#    timeout_in_minutes: 10
#
#  - label: "compute node build release"
#    command: "ci/scripts/compute-node-build.sh -t release -p release"
#    if: build.source != "schedule"
#    key: "release"
#    plugins:
#      - docker-compose#v3.9.0:
#          run: rw-build-env
#          config: ci/docker-compose.yml
#      - artifacts#v1.5.0:
#          upload:
#            - from: target/release/risingwave
#              to: risingwave-release
#            - from: target/release/risingwave_regress_test
#              to: risingwave_regress_test-release
#            - from: target/release/risedev-playground
#              to: risedev-playground-release
#    timeout_in_minutes: 15

  - label: " {{matrix.profile}}: e2e risedev"
    command: "ci/scripts/e2e-risedev.sh -p {{matrix.profile}}"
    depends_on: "build"
    timeout_in_minutes: 10
    plugins:
      - docker-compose#v3.9.0:
          run: rw-build-env
          config: ci/docker-compose.yml
    matrix:
      setup:
        profile:
          - "dev"
          - "release"


#  - label: "dev: e2e risedev"
#    command: "ci/scripts/e2e-risedev.sh"
#    depends_on: "dev"
#    plugins:
#      - docker-compose#v3.9.0:
#          run: rw-build-env
#          config: ci/docker-compose.yml
#      - artifacts#v1.5.0:
#          download:
#            - from: risingwave-dev
#              to: target/debug/risingwave
#            - from: risedev-playground-dev
#              to: target/debug/risedev-playground
#    timeout_in_minutes: 10
#
#  - label: "release: e2e risedev"
#    command: "ci/scripts/e2e-risedev.sh"
#    if: build.source != "schedule"
#    depends_on: "release"
#    plugins:
#      - docker-compose#v3.9.0:
#          run: rw-build-env
#          config: ci/docker-compose.yml
#      - artifacts#v1.5.0:
#          download:
#            - from: risingwave-release
#              to: target/debug/risingwave
#            - from: risedev-playground-release
#              to: target/debug/risedev-playground
#    timeout_in_minutes: 5

  - label: "e2e source"
    command: "ci/scripts/e2e-source.sh"
    depends_on: "dev"
    plugins:
      - docker-compose#v3.9.0:
          run: rw-build-env
          config: ci/docker-compose.yml
    timeout_in_minutes: 5

  - label: "compute node test"
    command: "ci/scripts/compute-node-test.sh"
    plugins:
      - docker-compose#v3.9.0:
          run: rw-build-env
          config: ci/docker-compose.yml
      - joscha/codecov#v2.1.6: ~
    timeout_in_minutes: 15

  - label: "misc check"
    command: "ci/scripts/misc-check.sh"
    plugins:
      - docker-compose#v3.9.0:
          run: rw-build-env
          config: ci/docker-compose.yml
      - shellcheck#v1.2.0:
            files: ./**/*.sh
    timeout_in_minutes: 10

